# .github/workflows/ci.yml

name: Professional Local Pipeline

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  train-and-deploy:
    runs-on: self-hosted # Cháº¡y trÃªn mÃ¡y báº¡n (WSL)
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Train Model
        run: |
          # Cháº¡y code train
          python src/ingest.py
          python src/preprocess.py
          python src/train.py
          # Káº¿t quáº£ train xong Ä‘ang náº±m á»Ÿ folder ./models (trong thÆ° má»¥c táº¡m cá»§a Runner)

      # --- [Sá»¬A ÄÆ¯á»œNG DáºªN Táº I ÄÃ‚Y] ---
      - name: Deploy Model to Project Folder
        run: |
          echo "ðŸš€ Copying model to local project folder..."
          
          # Äá»‹nh nghÄ©a thÆ° má»¥c Ä‘Ã­ch lÃ  Ä‘Æ°á»ng dáº«n tháº­t trÃªn mÃ¡y báº¡n
          TARGET_DIR="/mnt/c/Users/Admin/Desktop/sentiment_ci_cd/models"
          
          # Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
          mkdir -p $TARGET_DIR
          
          # Copy Ä‘Ã¨ file má»›i vÃ o (Force copy)
          cp -f models/model.pkl $TARGET_DIR/
          cp -f models/vectorizer.pkl $TARGET_DIR/
          
          echo "âœ… ÄÃ£ cáº­p nháº­t model má»›i táº¡i: $TARGET_DIR"

  build-docker:
    needs: train-and-deploy
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Downcase REPO
        run: echo "REPO_NAME=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      # Build Docker (LÆ°u Ã½: Image nÃ y sáº½ Rá»–NG pháº§n models)
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO_NAME }}/sentiment-api:latest