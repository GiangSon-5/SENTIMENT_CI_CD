name: Professional Local Pipeline

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  train-and-deploy:
    runs-on: self-hosted # Cháº¡y trÃªn mÃ¡y (WSL)
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Train Model
        env:
          # Truyá»n mÃ£ Commit vÃ o cho Python Ä‘á»c Ä‘á»ƒ Ä‘áº·t tÃªn Run
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python src/ingest.py
          python src/preprocess.py
          python src/train.py

      - name: Deploy Model and MLflow Data
        run: |
          echo "ðŸš€ Syncing artifacts to local project folder..."
          
          # Äá»•i TARGET_DIR thÃ nh thÆ° má»¥c gá»‘c dá»± Ã¡n
          PROJECT_ROOT="/mnt/c/Users/Admin/Desktop/sentiment_ci_cd"
          
          # 1. Cáº­p nháº­t Model (Ghi Ä‘Ã¨ báº£n cÅ© Ä‘á»ƒ API cháº¡y báº£n má»›i nháº¥t)
          mkdir -p $PROJECT_ROOT/models
          cp -f models/model.pkl $PROJECT_ROOT/models/
          cp -f models/vectorizer.pkl $PROJECT_ROOT/models/
          
          # 2. Cáº­p nháº­t MLflow (Quan trá»ng: Gá»˜P dá»¯ liá»‡u, khÃ´ng xÃ³a cÅ©)
          if [ -d "mlruns" ]; then
            echo "Found new mlruns data. Merging..."
            mkdir -p $PROJECT_ROOT/mlruns
            # Copy Ä‘á»‡ quy táº¥t cáº£ cÃ¡c run má»›i vá»
            cp -rf mlruns/* $PROJECT_ROOT/mlruns/
          fi
          
          echo "âœ… ÄÃ£ Ä‘á»“ng bá»™ Model vÃ  History vá»: $PROJECT_ROOT"

  build-docker:
    needs: train-and-deploy
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Downcase REPO
        run: echo "REPO_NAME=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO_NAME }}/sentiment-api:latest